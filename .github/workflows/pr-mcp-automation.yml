name: PR MCP Automation

# ç•¶ PR è¢«å‰µå»ºæˆ–æ›´æ–°æ™‚è§¸ç™¼
on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  run-mcp-tests:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write  # éœ€è¦æ¬Šé™ä¾†ç™¼å¸ƒè©•è«–

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Build TypeScript
        run: npm run build

      - name: Run MCP Tests
        id: mcp-tests
        env:
          GITHUB_ACCESS_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ§ª åŸ·è¡Œ MCP å·¥å…·æ¸¬è©¦..."

          # åŸ·è¡Œæ¸¬è©¦ä¸¦æ•ç²è¼¸å‡º
          node test-mcp-tools.js > test-output.txt 2>&1 || true

          # è®€å–æ¸¬è©¦è¼¸å‡º
          echo "test_output<<EOF" >> $GITHUB_OUTPUT
          cat test-output.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Test Report Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const testOutput = `${{ steps.mcp-tests.outputs.test_output }}`;

            // æ§‹å»ºè©•è«–å…§å®¹
            const comment = `## ğŸ¤– MCP è‡ªå‹•åŒ–æ¸¬è©¦å ±å‘Š

            **è§¸ç™¼äº‹ä»¶**: PR #${{ github.event.pull_request.number }} å‰µå»º/æ›´æ–°
            **åˆ†æ”¯**: \`${{ github.head_ref }}\` â†’ \`${{ github.base_ref }}\`
            **æäº¤**: ${{ github.event.pull_request.head.sha }}
            **ä½œè€…**: @${{ github.event.pull_request.user.login }}

            ---

            ### ğŸ“Š æ¸¬è©¦åŸ·è¡Œçµæœ

            \`\`\`
            ${testOutput}
            \`\`\`

            ---

            ### ğŸ“ æ¸¬è©¦é …ç›®

            - âœ… github_get_pull_requests - ç²å– PR åˆ—è¡¨
            - âœ… github_get_pull_request - ç²å– PR è©³æƒ…
            - âœ… github_get_pr_files - ç²å– PR æ–‡ä»¶è®Šæ›´
            - âœ… github_get_pr_comments - ç²å– PR è©•è«–
            - âœ… github_create_pr_comment - å‰µå»º PR è©•è«–
            - âœ… github_get_repository - ç²å–å€‰åº«è³‡è¨Š
            - âœ… github_get_commits - ç²å–æäº¤æ­·å²

            ---

            ğŸ¤– æ­¤è©•è«–ç”± GitHub Actions è‡ªå‹•ç”Ÿæˆ
            â° åŸ·è¡Œæ™‚é–“: ${new Date().toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' })}
            `;

            // ç™¼å¸ƒè©•è«–
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

            console.log('âœ… æ¸¬è©¦å ±å‘Šå·²ç™¼å¸ƒåˆ° PR è©•è«–ä¸­');

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mcp-test-results
          path: test-output.txt
          retention-days: 30
