#!/usr/bin/env node

/**
 * æ¸¬è©¦ GitHub MCP å·¥å…·åŠŸèƒ½
 */

import { GitHubClient } from './dist/github-client.js';

const REPO = 'BBsBrezz/Gitlab-MCP';
const PR_NUMBER = 1;

const client = new GitHubClient();

async function testMCPTools() {
  console.log('ğŸ§ª æ¸¬è©¦ GitHub MCP å·¥å…·åŠŸèƒ½\n');
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

  try {
    // 1. æ¸¬è©¦ç²å– PR åˆ—è¡¨
    console.log('1ï¸âƒ£ æ¸¬è©¦ github_get_pull_requests...');
    const prs = await client.getPullRequests(REPO, { state: 'open', per_page: 5 });
    console.log(`âœ… æ‰¾åˆ° ${prs.length} å€‹é–‹æ”¾çš„ PR:`);
    prs.forEach(pr => {
      console.log(`   - #${pr.number}: ${pr.title}`);
      console.log(`     ç‹€æ…‹: ${pr.state}, åˆ†æ”¯: ${pr.head.ref} â†’ ${pr.base.ref}`);
    });
    console.log('');

    // 2. æ¸¬è©¦ç²å– PR è©³æƒ…
    console.log(`2ï¸âƒ£ æ¸¬è©¦ github_get_pull_request (PR #${PR_NUMBER})...`);
    const pr = await client.getPullRequest(REPO, PR_NUMBER);
    console.log(`âœ… PR #${pr.number}: ${pr.title}`);
    console.log(`   ä½œè€…: ${pr.user.login}`);
    console.log(`   ç‹€æ…‹: ${pr.state}`);
    console.log(`   å¯åˆä½µ: ${pr.mergeable ? 'æ˜¯' : pr.mergeable === false ? 'å¦' : 'æª¢æŸ¥ä¸­...'}`);
    console.log(`   åˆ†æ”¯: ${pr.head.ref} â†’ ${pr.base.ref}`);
    console.log(`   è®Šæ›´: +${pr.additions} -${pr.deletions} (${pr.changed_files} å€‹æ–‡ä»¶)`);
    console.log(`   å»ºç«‹æ™‚é–“: ${new Date(pr.created_at).toLocaleString()}`);
    console.log(`   URL: ${pr.html_url}`);
    console.log('');

    // 3. æ¸¬è©¦ç²å– PR æ–‡ä»¶è®Šæ›´
    console.log(`3ï¸âƒ£ æ¸¬è©¦ github_get_pr_files (PR #${PR_NUMBER})...`);
    const files = await client.getPullRequestFiles(REPO, PR_NUMBER);
    console.log(`âœ… æ‰¾åˆ° ${files.length} å€‹è®Šæ›´æ–‡ä»¶:`);
    files.slice(0, 5).forEach(file => {
      const status = file.status === 'added' ? 'æ–°å¢' :
                     file.status === 'modified' ? 'ä¿®æ”¹' :
                     file.status === 'removed' ? 'åˆªé™¤' : file.status;
      console.log(`   - ${status}: ${file.filename}`);
      console.log(`     +${file.additions} -${file.deletions}`);
    });
    if (files.length > 5) {
      console.log(`   ... é‚„æœ‰ ${files.length - 5} å€‹æ–‡ä»¶`);
    }
    console.log('');

    // 4. æ¸¬è©¦ç²å– PR è©•è«–
    console.log(`4ï¸âƒ£ æ¸¬è©¦ github_get_pr_comments (PR #${PR_NUMBER})...`);
    const comments = await client.getPullRequestComments(REPO, PR_NUMBER);
    console.log(`âœ… æ‰¾åˆ° ${comments.length} å‰‡è©•è«–`);
    if (comments.length > 0) {
      comments.forEach(comment => {
        console.log(`   - ${comment.user.login}: ${comment.body.substring(0, 50)}...`);
      });
    } else {
      console.log(`   (ç›®å‰æ²’æœ‰è©•è«–)`);
    }
    console.log('');

    // 5. æ¸¬è©¦å‰µå»º PR è©•è«–
    console.log(`5ï¸âƒ£ æ¸¬è©¦ github_create_pr_comment (PR #${PR_NUMBER})...`);
    const newComment = await client.createPullRequestComment(REPO, PR_NUMBER, {
      body: `ğŸ¤– **è‡ªå‹•åŒ–æ¸¬è©¦è©•è«–**

é€™æ˜¯ä¸€å‰‡ç”± GitHub MCP å·¥å…·è‡ªå‹•å‰µå»ºçš„æ¸¬è©¦è©•è«–ï¼

## æ¸¬è©¦é …ç›®
- âœ… PR åˆ—è¡¨ç²å–
- âœ… PR è©³æƒ…ç²å–
- âœ… PR æ–‡ä»¶è®Šæ›´ç²å–
- âœ… PR è©•è«–ç²å–
- âœ… PR è©•è«–å‰µå»º

æ‰€æœ‰åŠŸèƒ½æ¸¬è©¦é€šéï¼ğŸ‰

---
_Generated by GitHub MCP Test Suite @ ${new Date().toLocaleString()}_`
    });
    console.log(`âœ… è©•è«–å‰µå»ºæˆåŠŸ!`);
    console.log(`   è©•è«– ID: ${newComment.id}`);
    console.log(`   URL: ${newComment.html_url}`);
    console.log('');

    // 6. æ¸¬è©¦ç²å–å€‰åº«è³‡è¨Š
    console.log(`6ï¸âƒ£ æ¸¬è©¦ github_get_repository...`);
    const repo = await client.getRepository(REPO);
    console.log(`âœ… å€‰åº«: ${repo.full_name}`);
    console.log(`   æè¿°: ${repo.description || 'ç„¡æè¿°'}`);
    console.log(`   é è¨­åˆ†æ”¯: ${repo.default_branch}`);
    console.log(`   æ˜Ÿæ¨™: ${repo.stargazers_count}`);
    console.log(`   èªè¨€: ${repo.language || 'N/A'}`);
    console.log('');

    // 7. æ¸¬è©¦ç²å–æäº¤æ­·å²
    console.log(`7ï¸âƒ£ æ¸¬è©¦ github_get_commits...`);
    const commits = await client.getCommits(REPO, { per_page: 3 });
    console.log(`âœ… æœ€è¿‘ ${commits.length} å€‹æäº¤:`);
    commits.forEach(commit => {
      const message = commit.commit.message.split('\n')[0];
      console.log(`   - ${commit.sha.substring(0, 7)}: ${message}`);
      console.log(`     ä½œè€…: ${commit.commit.author.name}`);
    });
    console.log('');

    // æ¸¬è©¦ç¸½çµ
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('âœ… æ‰€æœ‰ MCP å·¥å…·æ¸¬è©¦å®Œæˆ!');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
    console.log('æ¸¬è©¦çš„å·¥å…·:');
    console.log('  âœ… github_get_pull_requests');
    console.log('  âœ… github_get_pull_request');
    console.log('  âœ… github_get_pr_files');
    console.log('  âœ… github_get_pr_comments');
    console.log('  âœ… github_create_pr_comment');
    console.log('  âœ… github_get_repository');
    console.log('  âœ… github_get_commits');
    console.log('');
    console.log('ğŸ‰ GitHub MCP ä¼ºæœå™¨åŠŸèƒ½å®Œå…¨æ­£å¸¸!\n');

    return {
      success: true,
      pr: pr,
      comment: newComment
    };

  } catch (error) {
    console.error('âŒ æ¸¬è©¦å¤±æ•—:', error.message);
    if (error.response) {
      console.error(`HTTP ç‹€æ…‹: ${error.response.status}`);
      console.error(`éŒ¯èª¤è©³æƒ…: ${JSON.stringify(error.response.data, null, 2)}`);
    }
    throw error;
  }
}

// åŸ·è¡Œæ¸¬è©¦
testMCPTools().catch(error => {
  console.error('æ¸¬è©¦éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤:', error);
  process.exit(1);
});
